---
import fs from "node:fs/promises";
import path from "node:path";

function niceName(slug: string) {
  return slug
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ")
    .trim()
    .replace(/\b\w/g, (c) => c.toUpperCase());
}

// Map URL sport -> actual folder name on disk (Cloudflare/Linux is case-sensitive)
const sportFolderMap: Record<string, string> = {
  baseball: "baseball",
  basketball: "Basketball", // IMPORTANT: your repo currently uses capital B
  football: "football",
};

export async function getStaticPaths() {
  const sports = ["baseball", "basketball", "football"];
  const paths: { params: { sport: string; set: string } }[] = [];

  for (const sport of sports) {
    const folder = sportFolderMap[sport] ?? sport;
    const sportDir = path.join(process.cwd(), "public", "cards", folder);

    const entries = await fs.readdir(sportDir, { withFileTypes: true }).catch(() => []);
    const sets = entries.filter((e) => e.isDirectory()).map((e) => e.name);

    for (const set of sets) {
      paths.push({ params: { sport, set } });
    }
  }

  return paths;
}

const sport = (Astro.params.sport ?? "").toString();
const set = (Astro.params.set ?? "").toString();

const folder = sportFolderMap[sport] ?? sport;

// Where images live on disk
const setDir = path.join(process.cwd(), "public", "cards", folder, set);

// Read image files
const files = await fs.readdir(setDir).catch(() => []);
const images = files
  .filter((f) => /\.(webp|png|jpe?g|gif)$/i.test(f))
  .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" }));

const title = `${niceName(sport)} • ${niceName(set)}`;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>
  </head>

  <body class="min-h-screen bg-zinc-950 text-zinc-100">
    <main class="mx-auto max-w-6xl px-4 py-10">
      <div class="flex items-center justify-between gap-4">
        <a href={`/${sport}/`} class="text-sm text-zinc-400 hover:text-zinc-200">
          ← Back to {niceName(sport)} sets
        </a>

        <a href="/" class="text-sm text-zinc-400 hover:text-zinc-200">
          Home
        </a>
      </div>

      <h1 class="mt-3 text-3xl font-semibold tracking-tight">{niceName(set)}</h1>
      <p class="mt-2 text-zinc-300">
        {niceName(sport)} • {images.length} image{images.length === 1 ? "" : "s"}
      </p>

      {images.length === 0 ? (
        <div class="mt-6 rounded-2xl ring-1 ring-zinc-800 p-6 text-zinc-300">
          No images found in{" "}
          <code class="rounded bg-zinc-900 px-2 py-1 ring-1 ring-zinc-800">
            public/cards/{folder}/{set}/
          </code>
          <div class="mt-3 text-sm text-zinc-400">
            Add .webp/.jpg/.png files to that folder, commit, and push.
          </div>
        </div>
      ) : (
        <section class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {images.map((img) => (
            <a
              href={`/cards/${folder}/${set}/${img}`}
              class="group rounded-2xl bg-zinc-950 ring-1 ring-zinc-800 hover:ring-zinc-600 transition overflow-hidden"
              target="_blank"
              rel="noreferrer"
              title={img}
            >
              <div class="aspect-[3/4] bg-zinc-900/30 overflow-hidden">
                <img
                  src={`/cards/${folder}/${set}/${img}`}
                  alt={img}
                  loading="lazy"
                  class="h-full w-full object-contain group-hover:scale-[1.01] transition"
                />
              </div>
              <div class="p-4">
                <div class="text-sm font-medium text-zinc-200 truncate">{img}</div>
                <div class="mt-1 text-xs text-zinc-400">Open image →</div>
              </div>
            </a>
          ))}
        </section>
      )}
    </main>
  </body>
</html>
